---
title: "defining_estimator"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{defining_estimator}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(lotteryEstimator)
```

```{r}
str(examplePopulation)
```

```{r}
sample <- sampleExamplePopulation(10, 10)
str(sample)
```

## sample statistics

```{r}
totalCatch <- function(sample, species=c("COD", "HAD")){
  catches <- c()
  for (s in species){
    if (s %in% sample$speciesFAO){
      catches <- c(catches, sum(sample$wholeWeightKg[sample$speciesFAO==s]))
    }
    else{
      catches <- c(catches, 0)
    }
  }
  names(catches) <- species
  return(catches)
}

```


## Horwitz-Thompson estimation design: vessel, operation

```{r}
stage2HTtotal <- function(sample){hierarchicalHorvitzThompsonTotals(sample, "opid", totalCatch, "ipSSU")}

```

```{r}
stage2HTvariance <- function(sample){
  
  # get pairwise joint inclusion probabilities for SRSWOR
  stopifnot(length(unique(sample$nSSU)) == 1)
  stopifnot(length(unique(sample$Nssu)) == 1)
  n <- sample$nSSU[1]
  N <- sample$Nssu[1]
  
  jointInc <- srsworJointInclusionProbabilityMatrix(n,N)
  rownames(jointInc) <- unique(sample$opid)
  colnames(jointInc) <- unique(sample$opid)
  
  hierarchicalHorvitzThompsonCovariance(sample, 
                                        "opid", 
                                        totalCatch, 
                                        NULL, #there are no inter-species covariances of total cacth in one operation
                                        "ipSSU", 
                                        jointInc)
  
  }
```

```{r}
stage1HTtotal <- function(sample){hierarchicalHorvitzThompsonTotals(sample, "vesselId", stage2HTtotal, "ipPSU")}
```

```{r}
stage1HTvariance <- function(sample){
  
  # get pairwise joint inclusion probabilities for SRSWOR
  stopifnot(length(unique(sample$nPSU)) == 1)
  stopifnot(length(unique(sample$Npsu)) == 1)
  n <- sample$nPSU[1]
  N <- sample$Npsu[1]
  
  jointInc <- srsworJointInclusionProbabilityMatrix(n,N)
  rownames(jointInc) <- unique(sample$vesselId)
  colnames(jointInc) <- unique(sample$vesselId)
  
  hierarchicalHorvitzThompsonCovariance(sample, 
                                        "vesselId", 
                                        stage2HTtotal, 
                                        stage2HTvariance, # each sample is one observation, so the covariance is 0
                                        "ipPSU", 
                                        jointInc)
  
  }
```


```{r echo=F}
total <- totalCatch(examplePopulation)

stop("Bumb iterations to 1000 for report")

checkEstAllSampled <- checkEstimatorsExamplePopulation(stage1HTtotal, total, 2, 72, 365)

checkEst <- checkEstimatorsExamplePopulation(stage1HTtotal, total, 50, 20, 2)

se <- function(x){sqrt(diag(stage1HTvariance(x)))}
checkEstVar <- checkEstimatorsExamplePopulation(se, sqrt(checkEst$mean.sq.error), 50, 20, 2)


```


```{r}

stop("Bumb iterations to 1000 for report")
total <- totalCatch(examplePopulation)
checkEstLowPSUlowSSU <- checkEstimatorsExamplePopulation(stage1HTtotal, total, 50, 10, 2)
checkEstLowPSUhighSSU <- checkEstimatorsExamplePopulation(stage1HTtotal, total, 50, 10, 20)
checkEstHighPSUlowSSU <- checkEstimatorsExamplePopulation(stage1HTtotal, total, 50, 65, 2)
checkEstHighPSUhighSSU <- checkEstimatorsExamplePopulation(stage1HTtotal, total, 50, 65, 20)
```

## Hurvitz-Hansen estimation design: vessel, operation

## Hurvitz-Hansen estimation design: spatiotemporal, operation
